<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic Tac Toe</title>
    <script>
        let debug = true;
        let cells = null;
        let game_state = null;
        let input_game_id = null;
        let input_player = null;

        let game_id = null;
        let player_id = null;
        
        let init = () => {
            console.log("Game started! :)");

            input_game_id = document.getElementById("inputGameId");
            input_player_name = document.getElementById("inputPlayerName");
            synchronize_button = document.getElementById("synchronizeButton");
            
            game_id = input_game_id.value;
            player_id = input_player_name.value;

            input_game_id.addEventListener("input", () => {
                game_id = input_game_id.value;
            });

            input_player_name.addEventListener("input", () => {
                player_id = input_player_name.value;
            });

            synchronize_button.addEventListener("click", () => {
                synchronize_button.textContent = "üîÑ";
                synchronize().then((response) => {
                    synchronize_button.textContent = "‚úÖ";
                    console.log("Synchronize donetski!");
                    setTimeout(() => {
                        synchronize_button.textContent = "‚û°Ô∏è";
                    }, 5000)
                })
            });
        }
        
        window.addEventListener("load", () => {
            init();
        });

        let poll = () => {
            update_state().then((response) => {
                console.log("üîÑ");
                setTimeout(() => { poll(); }, 2000);
            });
        }

        let init_cells = () => {
            cells = document.getElementsByClassName("cell");
            cells = Array.from(cells);

            cells.map((cell, index) => {
                if (game_state.tiles[index] === null) {
                    cell.disabled = false;
                }
                else if (game_state.players.includes(player_id)) {
                    if (game_state.tiles[index] === player_id){
                        cell.disabled = true;
                        cell.style.backgroundColor = "green";
                    }
                    else {
                        cell.disabled = true;
                        cell.style.backgroundColor = "red";
                    }
                }
                else {
                    cell.disabled = true;
                    if (game_state.tiles[index] === game_state.players[0]) {
                        cell.style.backgroundColor = "yellow";
                    }
                    else if (game_state.tiles[index] === game_state.players[1]) {
                        cell.style.backgroundColor = "blue";
                    }
                }

                cell.textContent = index;
                cell.id = index;

                cell.addEventListener("click", async () => {
                    if (cell.disabled) {
                        return;
                    }

                    cell.disabled = true;
                    cell.style.backgroundColor = "green";

                    let response = await fetch(`${window.location}api/tick?gameId=${game_id}&tileId=${index}&playerId=${player_id}`);
                });
            });
        }

            let update_state = async () => {
                let game_data = await get_game();
                game_state = game_data.state;
                
                cells.map((cell, index) => {
                    if (game_state.tiles[index] === null) {
                        cell.disabled = false;
                    }
                    else if (game_state.players.includes(player_id)) {
                        if (game_state.tiles[index] === player_id){
                            cell.disabled = true;
                            cell.style.backgroundColor = "green";
                        }
                        else {
                            cell.disabled = true;
                            cell.style.backgroundColor = "red";
                        }
                    }
                    else {
                        cell.disabled = true;
                        if (game_state.tiles[index] === game_state.players[0]) {
                            cell.style.backgroundColor = "yellow";
                        }
                        else if (game_state.tiles[index] === game_state.players[1]) {
                            cell.style.backgroundColor = "blue";
                        }
                    }
                });
        }

        let synchronize = async () => {
            if (game_id === null || player_id === null) {
                console.log("Game ID and Player ID must be specified!");
                return;
            } 
            
            let game_data = await get_game();

            if (!game_data.success) {
                await new_game();
                game_data = await get_game();
            }

            if (!game_data.state.players.includes(player_id) && game_data.state.players.length < 2) {
                let register_response = await register_player();
                console.log("Joined game!");
                game_data = await get_game();
            }
            else if (game_data.state.players.includes(player_id)) {
                console.log("Joined game!");
            }
            else {
                console.log("Joining as spectator!");
            }

            game_state = game_data.state;
            init_cells();
            poll();
        }

        let get_game = async () => {
            let response = await fetch(`${window.location}api/get?gameId=${game_id}`);
            response = await response.text();
            response = JSON.parse(response);
            if (debug) {
                console.log(response);
            }
            return response;
        }

        let new_game = async () => {
            let response = await fetch(`${window.location}api/new`);
            response = await response.text();
            response = JSON.parse(response);
            if (debug) {
                console.log(response);
            }
            return response;
        }

        let register_player = async () => {
            let response = await fetch(`${window.location}api/register?gameId=${game_id}&playerId=${player_id}`);
            response = await response.text();
            response = JSON.parse(response);
            if (debug) {
                console.log(response);
            }
            return response;
        }
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        input {
            min-height: 2rem;
            font-size: 18px;
        }

        #board {
            display: grid;
            justify-content: center;
            grid-template-columns: repeat(3, 100px);
            grid-template-rows: repeat(3, 100px);
            gap: 2px;
            margin: 20px auto;
        }

        #boardSettings {
            margin: 20px auto;
            width: 20vw;
        }
        
        #synchronizeButton {
            flex-grow: 0.65;
            font-size: 48px;
            margin-left: 20px;
        }

        .flexRow {
            display: flex;
            flex-direction: row;
            justify-content: center;
        }

        .flexColumn {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .justifyEnd {
            justify-content: end;
        }

        .cell {
            border: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
        }

        .cell:hover {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
    <div id="board">
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
        <div class="cell"></div>
    </div>
    <div id="boardSettings" class="flexRow">
        <div class="flexColumn">
            <label for="inputGameId">Game ID</label>
            <input type="text" id="inputGameId" name="name"/>
            <label for="inputPlayerName">Player Name</label>
            <input type="text" id="inputPlayerName" name="name"/>
        </div>
        <div class="flexColumn justifyEnd">
            <button id="synchronizeButton">‚û°Ô∏è</button>
        </div>
    </div>
</body>
</html>
